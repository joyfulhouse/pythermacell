name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Cancel in-progress runs for the same workflow + branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write  # For PR comments

jobs:
  # Run lint and unit tests in parallel on multiple Python versions
  test-matrix:
    name: Test Suite
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.13", "3.14"]
    uses: ./.github/workflows/test.yml
    with:
      python-version: ${{ matrix.python-version }}
      run-integration: false
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # Integration tests run after unit tests pass
  # Only on PRs and main branch, requires manual approval
  integration-tests:
    name: Integration Tests
    needs: test-matrix
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    uses: ./.github/workflows/test.yml
    with:
      python-version: "3.13"
      run-integration: true
    environment: integration-tests
    secrets:
      THERMACELL_USERNAME: ${{ secrets.THERMACELL_USERNAME }}
      THERMACELL_PASSWORD: ${{ secrets.THERMACELL_PASSWORD }}
      THERMACELL_API_BASE_URL: ${{ secrets.THERMACELL_API_BASE_URL }}
      THERMACELL_TEST_NODE_ID: ${{ secrets.THERMACELL_TEST_NODE_ID }}

  # All checks passed
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [test-matrix, integration-tests]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.test-matrix.result }}" != "success" ]]; then
            echo "Test matrix failed"
            exit 1
          fi
          if [[ "${{ needs.integration-tests.result }}" != "success" && "${{ needs.integration-tests.result }}" != "skipped" ]]; then
            echo "Integration tests failed"
            exit 1
          fi
          echo "All CI checks passed!"
