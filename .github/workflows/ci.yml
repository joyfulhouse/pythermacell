name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Cancel in-progress runs for the same workflow + branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write  # For PR comments

jobs:
  # Run lint and unit tests in parallel on multiple Python versions
  test-matrix:
    name: Test Suite
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.13"]
    uses: ./.github/workflows/test.yml
    with:
      python-version: ${{ matrix.python-version }}
      run-integration: false
    secrets: inherit

  # Integration tests run after unit tests pass
  # Only on PRs and main branch, requires manual approval
  integration-tests:
    name: Integration Tests
    needs: test-matrix
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    uses: ./.github/workflows/test.yml
    with:
      python-version: "3.13"
      run-integration: true
    environment: integration-tests
    secrets: inherit

  # All checks passed - single required status check for branch protection
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [test-matrix, integration-tests]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          echo "Test matrix result: ${{ needs.test-matrix.result }}"
          echo "Integration tests result: ${{ needs.integration-tests.result }}"

          if [[ "${{ needs.test-matrix.result }}" != "success" ]]; then
            echo "❌ Test matrix failed"
            exit 1
          fi

          if [[ "${{ needs.integration-tests.result }}" != "success" && "${{ needs.integration-tests.result }}" != "skipped" ]]; then
            echo "❌ Integration tests failed"
            exit 1
          fi

          echo "✅ All CI checks passed!"
