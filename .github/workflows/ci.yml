name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Cancel in-progress runs for the same workflow + branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write  # For PR comments

jobs:
  # Run tests on Python 3.13
  test:
    name: Test Suite (Python 3.13)
    uses: ./.github/workflows/test.yml
    with:
      python-version: "3.13"
      run-integration: false
    secrets: inherit

  # Integration tests run after unit tests pass
  # Only on PRs and main branch, requires manual approval
  integration-tests:
    name: Integration Tests
    needs: test
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    uses: ./.github/workflows/test.yml
    with:
      python-version: "3.13"
      run-integration: true
    environment: integration-tests
    secrets: inherit

  # All checks passed - single required status check for branch protection
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [test, integration-tests]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          echo "Test result: ${{ needs.test.result }}"
          echo "Integration tests result: ${{ needs.integration-tests.result }}"

          if [[ "${{ needs.test.result }}" != "success" ]]; then
            echo "❌ Tests failed"
            exit 1
          fi

          if [[ "${{ needs.integration-tests.result }}" != "success" && "${{ needs.integration-tests.result }}" != "skipped" ]]; then
            echo "❌ Integration tests failed"
            exit 1
          fi

          echo "✅ All CI checks passed!"
